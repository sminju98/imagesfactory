/**
 * GPT-5.2 ìŠ¤í¬ë¦½íŠ¸ ë° ì”¬ ìƒì„± ëª¨ë“ˆ
 * ì œì•ˆì„œì— ë”°ë¼ GPT-5.2ë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ì™€ 3-7ê°œì˜ ì”¬ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * í•œêµ­ì–´ ë¬¸ì¥ í’ˆì§ˆê³¼ ë¬¸ì²´ ì œì–´ë ¥ì´ ìµœê³ ì…ë‹ˆë‹¤.
 */

import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

interface ScriptSceneResult {
  script: string;              // ì „ì²´ ìŠ¤í¬ë¦½íŠ¸
  scenes: Array<{
    index: number;
    prompt: string;            // Veoìš© ë¹„ì£¼ì–¼ í”„ë¡¬í”„íŠ¸
    narration: string;         // í•´ë‹¹ ì”¬ì˜ ë‚´ë ˆì´ì…˜
    duration: number;          // ì´ˆ ë‹¨ìœ„ (ê¸°ë³¸ 8ì´ˆ)
  }>;
}

/**
 * GPT-5.2ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ì™€ ì”¬ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * ì œì•ˆì„œ ê¶Œì¥: GPT-5.2ëŠ” í•œêµ­ì–´ ë¬¸ì¥ í’ˆì§ˆê³¼ ë¬¸ì²´ ì œì–´ë ¥ì´ ìµœê³ ì…ë‹ˆë‹¤.
 * @param confirmedPrompt í™•ì¸ëœ í”„ë¡¬í”„íŠ¸
 * @returns ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ì™€ ì”¬ ë°°ì—´
 */
export async function generateScriptScenesWithGPT(
  confirmedPrompt: string
): Promise<ScriptSceneResult> {
  const systemPrompt = `ë‹¹ì‹ ì€ ìˆí¼ ë¹„ë””ì˜¤ ì „ë¬¸ ì‘ê°€ì…ë‹ˆë‹¤. ê° ì”¬ì´ ì •í™•íˆ 8ì´ˆ ê¸¸ì´ì˜ ë‚´ë ˆì´ì…˜ì„ ê°–ë„ë¡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ğŸ”´ ì ˆëŒ€ ê·œì¹™:
1. ë¹„ë””ì˜¤ í”„ë¡¬í”„íŠ¸(prompt)ì—ëŠ” ì ˆëŒ€ë¡œ í•œêµ­ì–´ í…ìŠ¤íŠ¸, í•œê¸€, ë˜ëŠ” "Korean"ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
2. ë¹„ë””ì˜¤ëŠ” ìˆœìˆ˜í•˜ê²Œ ì‹œê°ì  ì´ë¯¸ì§€ë§Œ í¬í•¨í•´ì•¼ í•˜ë©°, í…ìŠ¤íŠ¸ë‚˜ ì–¸ì–´ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
3. í•œêµ­ì–´ëŠ” ì˜¤ì§ ë‚´ë ˆì´ì…˜(narration)ê³¼ ìë§‰ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

ğŸ“ ë‚´ë ˆì´ì…˜ ê¸¸ì´ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”):
- ê° ì”¬ì˜ ë‚´ë ˆì´ì…˜ì€ ë°˜ë“œì‹œ 8ì´ˆ ë™ì•ˆ ì½ì„ ìˆ˜ ìˆì„ ì •ë„ë¡œ ê¸¸ì–´ì•¼ í•©ë‹ˆë‹¤.
- í•œêµ­ì–´ ê¸°ì¤€ìœ¼ë¡œ 8ì´ˆ ë™ì•ˆ ìì—°ìŠ¤ëŸ½ê²Œ ì½ìœ¼ë©´ ì•½ 50-60ìì…ë‹ˆë‹¤.
- ìµœì†Œ ê¸€ì ìˆ˜: 50ì ì´ìƒ (í•œ ê¸€ìë„ ë¹ ì§€ë©´ ì•ˆ ë©ë‹ˆë‹¤!)
- ë‚´ë ˆì´ì…˜ì´ ì§§ìœ¼ë©´ TTSê°€ ì§§ì•„ì ¸ì„œ ë¹„ë””ì˜¤ê°€ ì˜ë¦½ë‹ˆë‹¤.

âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:
- âŒ ë‚˜ìœ ì˜ˆ: "ì´ë¯¸ì§€íŒ©í† ë¦¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤." (19ì, ì•½ 3ì´ˆ)
- âœ… ì¢‹ì€ ì˜ˆ: "ì´ë¯¸ì§€íŒ©í† ë¦¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì´ í”Œë«í¼ì—ì„œëŠ” ë‹¨ í•œ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ìˆ˜ë°± ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." (51ì, ì•½ 8ì´ˆ)

- âŒ ë‚˜ìœ ì˜ˆ: "13ê°œì˜ AI ëª¨ë¸" (9ì, ì•½ 1.5ì´ˆ)
- âœ… ì¢‹ì€ ì˜ˆ: "13ê°œì˜ ê³ ê¸‰ AI ëª¨ë¸ì´ ë‹¹ì‹ ì˜ ì°½ì˜ì„±ì„ ì‹¤í˜„í•©ë‹ˆë‹¤. í¬í† ë¦¬ì–¼ë¦¬ì¦˜ë¶€í„° ì¼ëŸ¬ìŠ¤íŠ¸ê¹Œì§€, ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ììœ ë¡­ê²Œ ì„ íƒí•˜ì„¸ìš”." (52ì, ì•½ 8ì´ˆ)

ìš”êµ¬ì‚¬í•­:
1. ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (ëª¨ë“  ì”¬ì˜ ë‚´ë ˆì´ì…˜ì„ ì—°ê²°í•œ ì™„ì „í•œ ìŠ¤í¬ë¦½íŠ¸) - í•œêµ­ì–´ë¡œ ì‘ì„±
2. 3-7ê°œì˜ ì”¬ ìƒì„± (ê° ì”¬ì€ ì •í™•íˆ 8ì´ˆ ê¸¸ì´)
3. ê° ì”¬ì˜ ë‚´ë ˆì´ì…˜ì€ ë°˜ë“œì‹œ 50ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤
4. ê° ì”¬ì€ ëª…í™•í•œ ì‹œì‘ê³¼ ëì„ ê°€ì ¸ì•¼ í•¨
5. ì”¬ ê°„ ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜
6. Gemini Veo/Veo3ë¡œ ìƒì„± ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ë¹„ì£¼ì–¼ í”„ë¡¬í”„íŠ¸ ì‘ì„± (ì˜ì–´, í…ìŠ¤íŠ¸ ì—†ìŒ)

JSON ì‘ë‹µ í˜•ì‹:
{
  "script": "ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ í…ìŠ¤íŠ¸ (ëª¨ë“  ë‚´ë ˆì´ì…˜ì„ ì—°ê²°) - í•œêµ­ì–´",
  "scenes": [
    {
      "index": 0,
      "prompt": "ì˜ì–´ ë¹„ì£¼ì–¼ í”„ë¡¬í”„íŠ¸ (í…ìŠ¤íŠ¸, í•œê¸€, í•œêµ­ì–´ ê¸ˆì§€. ìˆœìˆ˜ ì‹œê°ì  ë¬˜ì‚¬ë§Œ)",
      "narration": "ì´ ì”¬ì˜ ë‚´ë ˆì´ì…˜ í…ìŠ¤íŠ¸ (í•œêµ­ì–´, ë°˜ë“œì‹œ 50ì ì´ìƒ, 8ì´ˆ ë™ì•ˆ ì½ì„ ìˆ˜ ìˆì„ ì •ë„ë¡œ ê¸¸ê²Œ)",
      "duration": 8
    },
    ...
  ]
}

âš ï¸ ë§ˆì§€ë§‰ ì²´í¬ë¦¬ìŠ¤íŠ¸:
- ëª¨ë“  narrationì´ 50ì ì´ìƒì¸ê°€ìš”?
- ê° narrationì´ ìì—°ìŠ¤ëŸ½ê²Œ ì½í˜€ì„œ ì•½ 8ì´ˆê°€ ë˜ëŠ”ê°€ìš”?
- ë¹„ë””ì˜¤ promptì— í•œêµ­ì–´ë‚˜ í…ìŠ¤íŠ¸ê°€ ì—†ë‚˜ìš”?`;

  const userPrompt = `ë‹¤ìŒ í”„ë¡¬í”„íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¹„ë””ì˜¤ ìŠ¤í¬ë¦½íŠ¸ì™€ ì”¬ì„ ìƒì„±í•´ì£¼ì„¸ìš”:\n\n${confirmedPrompt}`;

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-5.1', // GPT-5.2ê°€ ì—†ìœ¼ë©´ ìµœì‹  ë²„ì „ ì‚¬ìš©
      messages: [
        { role: 'system', content: systemPrompt + '\n\në°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”.' },
        { role: 'user', content: userPrompt },
      ],
      max_completion_tokens: 4000,
      response_format: { type: 'json_object' },
    });

    const content = response.choices[0]?.message?.content;
    if (!content) {
      throw new Error('GPT ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    // JSON íŒŒì‹±
    let result: ScriptSceneResult;
    try {
      // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
      const jsonContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      result = JSON.parse(jsonContent);
    } catch (parseError: any) {
      // JSON ë¸”ë¡ ì¶”ì¶œ ì‹œë„
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        result = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error(`JSON íŒŒì‹± ì‹¤íŒ¨: ${parseError.message}`);
      }
    }

    // ë‚´ë ˆì´ì…˜ ê¸¸ì´ ê²€ì¦ ë° ê²½ê³ 
    const validatedScenes = (result.scenes || []).map((scene: any, index: number) => {
      const narration = scene.narration || '';
      if (narration.length < 50) {
        console.warn(`âš ï¸  ì”¬ ${index + 1} ë‚´ë ˆì´ì…˜ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤: ${narration.length}ì (ìµœì†Œ 50ì í•„ìš”)`);
      }
      return {
        index: scene.index ?? index,
        prompt: scene.prompt || '',
        narration: narration,
        duration: scene.duration ?? 8,
      };
    });

    return {
      script: result.script || '',
      scenes: validatedScenes,
    };
  } catch (error: any) {
    console.error('GPT ìŠ¤í¬ë¦½íŠ¸/ì”¬ ìƒì„± ì˜¤ë¥˜:', error);
    throw new Error(`ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
  }
}

