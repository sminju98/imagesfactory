# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ì„œ
# imagesfactory - Firebase Firestore

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ì‘ì„±ì¼**: 2025-11-23  
**ëŒ€ìƒ ë…ì**: ê°œë°œíŒ€

---

## ğŸ“‹ ê°œìš”

ë³¸ ë¬¸ì„œëŠ” imagesfactoryì˜ Firebase Firestore ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ ìƒì„¸íˆ ì •ì˜í•©ë‹ˆë‹¤.

---

## ğŸ—„ Firestore íŠ¹ì§•

### NoSQL ë¬¸ì„œ ê¸°ë°˜
- ì»¬ë ‰ì…˜(Collection) > ë¬¸ì„œ(Document) êµ¬ì¡°
- ë¬¸ì„œëŠ” JSON í˜•íƒœì˜ í‚¤-ê°’ ìŒ
- ì„œë¸Œì»¬ë ‰ì…˜ ì§€ì›
- ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì§€ì›

### ì¸ë±ì‹±
- ë‹¨ì¼ í•„ë“œ ì¸ë±ìŠ¤: ìë™ ìƒì„±
- ë³µí•© ì¸ë±ìŠ¤: ìˆ˜ë™ ìƒì„± í•„ìš”

### ìš©ëŸ‰ ì œí•œ
- ë¬¸ì„œ ìµœëŒ€ í¬ê¸°: 1MB
- ë¬¸ì„œ ID: 1500ì
- í•„ë“œëª…: 1500ì
- ë°°ì—´ ìµœëŒ€ ìš”ì†Œ: ì œí•œ ì—†ìŒ (ë‹¨, 1MB ì´ë‚´)

---

## ğŸ“Š ì „ì²´ ë°ì´í„° êµ¬ì¡°

```
firestore/
â”œâ”€â”€ users/                          # ì‚¬ìš©ì
â”‚   â””â”€â”€ {userId}
â”œâ”€â”€ imageGenerations/               # ì´ë¯¸ì§€ ìƒì„± ì‘ì—…
â”‚   â”œâ”€â”€ {generationId}
â”‚   â””â”€â”€ {generationId}/images/     # ì„œë¸Œì»¬ë ‰ì…˜: ìƒì„±ëœ ì´ë¯¸ì§€
â”‚       â””â”€â”€ {imageId}
â”œâ”€â”€ pointTransactions/              # í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­
â”‚   â””â”€â”€ {transactionId}
â”œâ”€â”€ payments/                       # ê²°ì œ ë‚´ì—­
â”‚   â””â”€â”€ {paymentId}
â”œâ”€â”€ notifications/                  # ì•Œë¦¼ (í–¥í›„)
â”‚   â””â”€â”€ {notificationId}
â””â”€â”€ analytics/                      # ë¶„ì„ ë°ì´í„° (í–¥í›„)
    â””â”€â”€ {date}
```

---

## ğŸ“ ì»¬ë ‰ì…˜ ìƒì„¸ ì„¤ê³„

## 1. users

**ê²½ë¡œ**: `/users/{userId}`  
**ë¬¸ì„œ ID**: Firebase Auth UID

### í•„ë“œ êµ¬ì¡°

```typescript
interface User {
  // ê¸°ë³¸ ì •ë³´
  uid: string;                    // Auth UID (ë¬¸ì„œ IDì™€ ë™ì¼)
  email: string;                  // ì´ë©”ì¼
  displayName: string;            // í‘œì‹œ ì´ë¦„
  photoURL?: string | null;       // í”„ë¡œí•„ ì‚¬ì§„ URL
  
  // ì¸ì¦ ì •ë³´
  provider: 'password' | 'google'; // ë¡œê·¸ì¸ ì œê³µì
  providerId?: string | null;     // ì†Œì…œ ë¡œê·¸ì¸ ID
  emailVerified: boolean;         // ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€
  
  // í¬ì¸íŠ¸
  points: number;                 // í˜„ì¬ í¬ì¸íŠ¸ ì”ì•¡
  
  // í†µê³„ (ì—­ì •ê·œí™” - ë¹ ë¥¸ ì¡°íšŒìš©)
  stats?: {
    totalGenerations: number;     // ì´ ìƒì„± ì‘ì—… ìˆ˜
    totalImages: number;          // ì´ ìƒì„± ì´ë¯¸ì§€ ìˆ˜
    totalPointsUsed: number;      // ì´ ì‚¬ìš© í¬ì¸íŠ¸
    totalPointsPurchased: number; // ì´ êµ¬ë§¤ í¬ì¸íŠ¸
    lastGenerationAt?: Timestamp | null;
  };
  
  // ì„¤ì •
  preferences?: {
    language: string;             // ì–¸ì–´ (ko, en)
    emailNotifications: boolean;  // ì´ë©”ì¼ ì•Œë¦¼ ìˆ˜ì‹ 
    defaultStyle: string;         // ê¸°ë³¸ ìŠ¤íƒ€ì¼
    defaultAspectRatio: string;   // ê¸°ë³¸ ë¹„ìœ¨
  };
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Timestamp;
  updatedAt: Timestamp;
  lastLoginAt?: Timestamp | null;
}
```

### ì˜ˆì‹œ ë¬¸ì„œ
```json
{
  "uid": "abc123xyz",
  "email": "user@example.com",
  "displayName": "í™ê¸¸ë™",
  "photoURL": null,
  "provider": "password",
  "providerId": null,
  "emailVerified": true,
  "points": 2500,
  "stats": {
    "totalGenerations": 15,
    "totalImages": 150,
    "totalPointsUsed": 15000,
    "totalPointsPurchased": 50000,
    "lastGenerationAt": "2025-11-23T10:00:00Z"
  },
  "preferences": {
    "language": "ko",
    "emailNotifications": true,
    "defaultStyle": "realistic",
    "defaultAspectRatio": "16:9"
  },
  "createdAt": "2025-11-01T10:00:00Z",
  "updatedAt": "2025-11-23T09:30:00Z",
  "lastLoginAt": "2025-11-23T09:30:00Z"
}
```

### ì¸ë±ìŠ¤
- `email` (ìë™)
- `provider` + `providerId` (ë³µí•© ì¸ë±ìŠ¤)
- `createdAt` (ìë™)

### ë³´ì•ˆ ê·œì¹™
```javascript
// ìì‹ ì˜ ë¬¸ì„œë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
// ë‹¨, points í•„ë“œëŠ” ì„œë²„ì—ì„œë§Œ ìˆ˜ì •
match /users/{userId} {
  allow read: if request.auth.uid == userId;
  allow create: if request.auth.uid == userId;
  allow update: if request.auth.uid == userId
    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['points']));
  allow delete: if request.auth.uid == userId;
}
```

---

## 2. imageGenerations

**ê²½ë¡œ**: `/imageGenerations/{generationId}`  
**ë¬¸ì„œ ID**: ìë™ ìƒì„± (UUID)

### í•„ë“œ êµ¬ì¡°

```typescript
interface ImageGeneration {
  // ê¸°ë³¸ ì •ë³´
  id: string;                     // ë¬¸ì„œ ID
  userId: string;                 // ì‚¬ìš©ì UID
  
  // í”„ë¡¬í”„íŠ¸
  prompt: string;                 // ì›ë³¸ í”„ë¡¬í”„íŠ¸
  promptKo?: string | null;       // í•œê¸€ í”„ë¡¬í”„íŠ¸ (í•œê¸€ ì…ë ¥ ì‹œ)
  promptTranslated: string;       // ì˜ë¬¸ ë²ˆì—­ í”„ë¡¬í”„íŠ¸ (AI API ì „ì†¡ìš©)
  
  // ìƒì„± ì„¤ì •
  imageCount: number;             // ìƒì„±í•  ì´ë¯¸ì§€ ìˆ˜ (1-50)
  style: string;                  // ìŠ¤íƒ€ì¼
  aspectRatio: string;            // ë¹„ìœ¨
  
  // ìƒíƒœ
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled';
  progress: number;               // ì§„í–‰ë¥  (0-100)
  
  // ë¹„ìš©
  pointsUsed: number;             // ì‚¬ìš©ëœ í¬ì¸íŠ¸
  
  // ê²°ê³¼
  zipUrl?: string | null;         // ZIP íŒŒì¼ URL (ì™„ë£Œ ì‹œ)
  completedCount?: number;        // ì™„ë£Œëœ ì´ë¯¸ì§€ ìˆ˜
  
  // ì‹¤íŒ¨ ì •ë³´
  failedReason?: string | null;   // ì‹¤íŒ¨ ì‚¬ìœ 
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Timestamp;
  updatedAt: Timestamp;
  completedAt?: Timestamp | null;
  
  // ë©”íƒ€ë°ì´í„°
  metadata?: {
    aiModel: string;              // ì‚¬ìš©ëœ AI ëª¨ë¸
    totalFileSize?: number;       // ì´ íŒŒì¼ í¬ê¸° (bytes)
    averageGenerationTime?: number; // í‰ê·  ìƒì„± ì‹œê°„ (ì´ˆ)
  };
}
```

### ì˜ˆì‹œ ë¬¸ì„œ
```json
{
  "id": "gen_xyz123abc",
  "userId": "abc123xyz",
  "prompt": "a beautiful sunset over the ocean",
  "promptKo": "ë°”ë‹¤ ìœ„ì˜ ì•„ë¦„ë‹¤ìš´ ì¼ëª°",
  "promptTranslated": "a beautiful sunset over the ocean",
  "imageCount": 10,
  "style": "realistic",
  "aspectRatio": "16:9",
  "status": "completed",
  "progress": 100,
  "pointsUsed": 1000,
  "zipUrl": "https://storage.googleapis.com/.../gen_xyz123abc.zip",
  "completedCount": 10,
  "failedReason": null,
  "createdAt": "2025-11-23T10:00:00Z",
  "updatedAt": "2025-11-23T10:25:00Z",
  "completedAt": "2025-11-23T10:25:00Z",
  "metadata": {
    "aiModel": "dall-e-3",
    "totalFileSize": 20971520,
    "averageGenerationTime": 28.5
  }
}
```

### ì¸ë±ìŠ¤ (ë³µí•© ì¸ë±ìŠ¤ í•„ìš”)
```
1. userId (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
2. userId (ì˜¤ë¦„ì°¨ìˆœ) + status (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
3. status (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
```

### ë³´ì•ˆ ê·œì¹™
```javascript
match /imageGenerations/{generationId} {
  allow read: if request.auth.uid == resource.data.userId;
  allow create: if request.auth.uid == request.resource.data.userId
    && request.resource.data.status == 'pending';
  allow update: if false; // ì„œë²„ì—ì„œë§Œ ì—…ë°ì´íŠ¸
  allow delete: if request.auth.uid == resource.data.userId;
}
```

---

## 2-1. images (ì„œë¸Œì»¬ë ‰ì…˜)

**ê²½ë¡œ**: `/imageGenerations/{generationId}/images/{imageId}`  
**ë¬¸ì„œ ID**: ìë™ ìƒì„±

### í•„ë“œ êµ¬ì¡°

```typescript
interface Image {
  id: string;                     // ë¬¸ì„œ ID
  generationId: string;           // ë¶€ëª¨ generation ID
  
  // ì´ë¯¸ì§€ ì •ë³´
  imageUrl: string;               // ì›ë³¸ ì´ë¯¸ì§€ URL (Firebase Storage)
  thumbnailUrl: string;           // ì¸ë„¤ì¼ URL
  
  // ìˆœì„œ
  order: number;                  // ìƒì„± ìˆœì„œ (1ë¶€í„° ì‹œì‘)
  
  // ë©”íƒ€ë°ì´í„°
  width: number;                  // ë„ˆë¹„ (px)
  height: number;                 // ë†’ì´ (px)
  fileSize: number;               // íŒŒì¼ í¬ê¸° (bytes)
  format: string;                 // íŒŒì¼ í˜•ì‹ (png, jpg)
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Timestamp;
}
```

### ì˜ˆì‹œ ë¬¸ì„œ
```json
{
  "id": "img_001",
  "generationId": "gen_xyz123abc",
  "imageUrl": "https://storage.googleapis.com/.../0.png",
  "thumbnailUrl": "https://storage.googleapis.com/.../0_thumb.png",
  "order": 1,
  "width": 1792,
  "height": 1024,
  "fileSize": 2048576,
  "format": "png",
  "createdAt": "2025-11-23T10:01:30Z"
}
```

### ì¸ë±ìŠ¤
- `order` (ìë™)

### ë³´ì•ˆ ê·œì¹™
```javascript
match /imageGenerations/{generationId}/images/{imageId} {
  allow read: if request.auth.uid == 
    get(/databases/$(database)/documents/imageGenerations/$(generationId)).data.userId;
  allow write: if false; // ì„œë²„ì—ì„œë§Œ
}
```

---

## 3. pointTransactions

**ê²½ë¡œ**: `/pointTransactions/{transactionId}`  
**ë¬¸ì„œ ID**: ìë™ ìƒì„±

### í•„ë“œ êµ¬ì¡°

```typescript
interface PointTransaction {
  id: string;                     // ë¬¸ì„œ ID
  userId: string;                 // ì‚¬ìš©ì UID
  
  // ê±°ë˜ ì •ë³´
  amount: number;                 // ê¸ˆì•¡ (ì–‘ìˆ˜: ì¶©ì „/ë³´ë„ˆìŠ¤, ìŒìˆ˜: ì‚¬ìš©/ì°¨ê°)
  type: 'purchase' | 'usage' | 'refund' | 'bonus' | 'admin_adjust';
  description: string;            // ì„¤ëª…
  
  // ì—°ê´€ ì •ë³´
  relatedGenerationId?: string | null;  // ê´€ë ¨ ìƒì„± ì‘ì—… ID
  relatedPaymentId?: string | null;     // ê´€ë ¨ ê²°ì œ ID
  
  // ì”ì•¡
  balanceBefore: number;          // ê±°ë˜ ì „ ì”ì•¡
  balanceAfter: number;           // ê±°ë˜ í›„ ì”ì•¡
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Timestamp;
  
  // ë©”íƒ€ë°ì´í„°
  metadata?: {
    adminId?: string;             // ê´€ë¦¬ì ì¡°ì • ì‹œ ê´€ë¦¬ì ID
    reason?: string;              // ê´€ë¦¬ì ì¡°ì • ì‚¬ìœ 
  };
}
```

### ì˜ˆì‹œ ë¬¸ì„œ
```json
{
  "id": "txn_abc123",
  "userId": "abc123xyz",
  "amount": -1000,
  "type": "usage",
  "description": "ì´ë¯¸ì§€ 10ì¥ ìƒì„±",
  "relatedGenerationId": "gen_xyz123abc",
  "relatedPaymentId": null,
  "balanceBefore": 3500,
  "balanceAfter": 2500,
  "createdAt": "2025-11-23T10:00:00Z"
}
```

### ì¸ë±ìŠ¤ (ë³µí•© ì¸ë±ìŠ¤ í•„ìš”)
```
1. userId (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
2. userId (ì˜¤ë¦„ì°¨ìˆœ) + type (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
```

### ë³´ì•ˆ ê·œì¹™
```javascript
match /pointTransactions/{transactionId} {
  allow read: if request.auth.uid == resource.data.userId;
  allow write: if false; // ì„œë²„ì—ì„œë§Œ
}
```

---

## 4. payments

**ê²½ë¡œ**: `/payments/{paymentId}`  
**ë¬¸ì„œ ID**: ìë™ ìƒì„±

### í•„ë“œ êµ¬ì¡°

```typescript
interface Payment {
  id: string;                     // ë¬¸ì„œ ID
  userId: string;                 // ì‚¬ìš©ì UID
  
  // ê¸ˆì•¡
  amount: number;                 // ê²°ì œ ê¸ˆì•¡ (ì›)
  points: number;                 // ì¶©ì „ í¬ì¸íŠ¸
  
  // ìƒíƒœ
  status: 'pending' | 'completed' | 'failed' | 'cancelled' | 'refunded';
  
  // í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ë³´
  orderId: string;                // ì£¼ë¬¸ ID (ê³ ìœ )
  paymentKey?: string | null;     // í† ìŠ¤ ê²°ì œ í‚¤
  transactionId?: string | null;  // í† ìŠ¤ ê±°ë˜ ID
  paymentMethod?: string | null;  // ê²°ì œ ìˆ˜ë‹¨
  
  // ì˜ìˆ˜ì¦
  receiptUrl?: string | null;     // ì˜ìˆ˜ì¦ URL
  
  // ì‹¤íŒ¨ ì •ë³´
  failReason?: string | null;     // ì‹¤íŒ¨ ì‚¬ìœ 
  
  // í™˜ë¶ˆ ì •ë³´
  refundedAmount?: number;        // í™˜ë¶ˆ ê¸ˆì•¡
  refundedAt?: Timestamp | null;  // í™˜ë¶ˆ ì¼ì‹œ
  refundReason?: string | null;   // í™˜ë¶ˆ ì‚¬ìœ 
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Timestamp;
  updatedAt: Timestamp;
  confirmedAt?: Timestamp | null;
  
  // ë©”íƒ€ë°ì´í„°
  metadata?: {
    packageId: string;            // êµ¬ë§¤í•œ íŒ¨í‚¤ì§€ ID
    userAgent?: string;           // ì‚¬ìš©ì ì—ì´ì „íŠ¸
    ipAddress?: string;           // IP ì£¼ì†Œ
  };
}
```

### ì˜ˆì‹œ ë¬¸ì„œ
```json
{
  "id": "pay_abc123",
  "userId": "abc123xyz",
  "amount": 40000,
  "points": 10000,
  "status": "completed",
  "orderId": "order_2025112310001",
  "paymentKey": "tviva20211215va123abc",
  "transactionId": "tx_abc123",
  "paymentMethod": "ì¹´ë“œ",
  "receiptUrl": "https://dashboard.tosspayments.com/receipt/...",
  "failReason": null,
  "refundedAmount": null,
  "refundedAt": null,
  "refundReason": null,
  "createdAt": "2025-11-23T10:00:00Z",
  "updatedAt": "2025-11-23T10:05:00Z",
  "confirmedAt": "2025-11-23T10:05:00Z",
  "metadata": {
    "packageId": "pro",
    "userAgent": "Mozilla/5.0...",
    "ipAddress": "123.456.789.0"
  }
}
```

### ì¸ë±ìŠ¤ (ë³µí•© ì¸ë±ìŠ¤ í•„ìš”)
```
1. userId (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
2. userId (ì˜¤ë¦„ì°¨ìˆœ) + status (ì˜¤ë¦„ì°¨ìˆœ) + createdAt (ë‚´ë¦¼ì°¨ìˆœ)
3. orderId (ì˜¤ë¦„ì°¨ìˆœ) - ê³ ìœ  ì¸ë±ìŠ¤
4. paymentKey (ì˜¤ë¦„ì°¨ìˆœ) - ê³ ìœ  ì¸ë±ìŠ¤
```

### ë³´ì•ˆ ê·œì¹™
```javascript
match /payments/{paymentId} {
  allow read: if request.auth.uid == resource.data.userId;
  allow create: if request.auth.uid == request.resource.data.userId
    && request.resource.data.status == 'pending';
  allow update, delete: if false; // ì„œë²„ì—ì„œë§Œ
}
```

---

## 5. notifications (í–¥í›„)

**ê²½ë¡œ**: `/notifications/{notificationId}`  
**ë¬¸ì„œ ID**: ìë™ ìƒì„±

### í•„ë“œ êµ¬ì¡°

```typescript
interface Notification {
  id: string;
  userId: string;
  
  type: 'generation_complete' | 'generation_failed' | 'payment_complete' | 'system';
  title: string;
  message: string;
  
  read: boolean;
  
  relatedId?: string | null;      // ê´€ë ¨ ë¬¸ì„œ ID
  actionUrl?: string | null;      // í´ë¦­ ì‹œ ì´ë™ URL
  
  createdAt: Timestamp;
}
```

---

## 6. analytics (í–¥í›„)

**ê²½ë¡œ**: `/analytics/{date}`  
**ë¬¸ì„œ ID**: YYYY-MM-DD í˜•ì‹

### í•„ë“œ êµ¬ì¡°

```typescript
interface DailyAnalytics {
  date: string;                   // YYYY-MM-DD
  
  users: {
    newSignups: number;
    activeUsers: number;
  };
  
  generations: {
    total: number;
    completed: number;
    failed: number;
  };
  
  images: {
    total: number;
  };
  
  revenue: {
    amount: number;
    transactions: number;
  };
  
  createdAt: Timestamp;
}
```

---

## ğŸ”§ Firestore ìš´ì˜

### ë°ì´í„° ë°±ì—…

**ìë™ ë°±ì—… (Firebase Console)**:
1. Firestore > ë°±ì—… ë° ë³µì›
2. ë°±ì—… ì¼ì • ì„¤ì • (ë§¤ì¼ ìë™)
3. ë³´ê´€ ê¸°ê°„: 30ì¼

**ìˆ˜ë™ ë°±ì—…**:
```bash
gcloud firestore export gs://[BUCKET_NAME]/[BACKUP_FOLDER]
```

### ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

**ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ** (Admin SDK):
```typescript
import * as admin from 'firebase-admin';

admin.initializeApp();
const db = admin.firestore();

// ëª¨ë“  ì‚¬ìš©ìì—ê²Œ stats í•„ë“œ ì¶”ê°€
async function migrateUsers() {
  const usersRef = db.collection('users');
  const snapshot = await usersRef.get();
  
  const batch = db.batch();
  let count = 0;
  
  snapshot.forEach((doc) => {
    const userRef = usersRef.doc(doc.id);
    batch.update(userRef, {
      'stats.totalGenerations': 0,
      'stats.totalImages': 0,
      'stats.totalPointsUsed': 0,
      'stats.totalPointsPurchased': 0,
    });
    
    count++;
    
    // BatchëŠ” ìµœëŒ€ 500ê°œ
    if (count >= 500) {
      batch.commit();
      count = 0;
    }
  });
  
  if (count > 0) {
    await batch.commit();
  }
}
```

### ì¸ë±ìŠ¤ ìƒì„±

**firestore.indexes.json**:
```json
{
  "indexes": [
    {
      "collectionGroup": "imageGenerations",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "imageGenerations",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "pointTransactions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "payments",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

ë°°í¬:
```bash
firebase deploy --only firestore:indexes
```

### ë°ì´í„° ì •ë¦¬

**ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬ (Cloud Function)**:
```typescript
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

// ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” ì •ë¦¬ í•¨ìˆ˜
export const cleanupOldData = functions
  .pubsub.schedule('0 3 * * *')  // ë§¤ì¼ ìƒˆë²½ 3ì‹œ
  .timeZone('Asia/Seoul')
  .onRun(async (context) => {
    const db = admin.firestore();
    const ninetyDaysAgo = new Date();
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
    
    // 90ì¼ ì´ìƒ ì§€ë‚œ ì™„ë£Œëœ ìƒì„± ì‘ì—… ì‚­ì œ
    const snapshot = await db.collection('imageGenerations')
      .where('status', '==', 'completed')
      .where('completedAt', '<', ninetyDaysAgo)
      .get();
    
    const batch = db.batch();
    
    snapshot.forEach((doc) => {
      batch.delete(doc.ref);
    });
    
    await batch.commit();
    
    console.log(`Deleted ${snapshot.size} old generations`);
  });
```

---

## ğŸ“Š ì˜ˆìƒ ìš©ëŸ‰ ë° ë¹„ìš©

### ë¬¸ì„œ í¬ê¸° ì˜ˆìƒ
- User: ~1KB
- ImageGeneration: ~2KB
- Image: ~0.5KB
- PointTransaction: ~0.5KB
- Payment: ~1KB

### ì›”ê°„ ì˜ˆìƒ (1,000 í™œì„± ìœ ì € ê¸°ì¤€)
- Users: 1,000 ë¬¸ì„œ = ~1MB
- ImageGenerations: 3,000 ë¬¸ì„œ = ~6MB
- Images: 30,000 ë¬¸ì„œ = ~15MB
- PointTransactions: 5,000 ë¬¸ì„œ = ~2.5MB
- Payments: 500 ë¬¸ì„œ = ~0.5MB

**ì´**: ~25MB/ì›”

### Firestore ë¹„ìš© (ì˜ˆìƒ)
- ì €ì¥: 25MB x $0.18/GB = $0.0045
- ì½ê¸°: 100,000 x $0.06/100K = $0.06
- ì“°ê¸°: 50,000 x $0.18/100K = $0.09

**ì´**: ~$0.15/ì›” (ì´ˆê¸°)

---

**ë¬¸ì„œ íˆìŠ¤í† ë¦¬**
- v1.0 (2025-11-23): ì´ˆì•ˆ ì‘ì„±

