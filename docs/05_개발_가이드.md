# ê°œë°œ ê°€ì´ë“œ
# imagesfactory

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ì‘ì„±ì¼**: 2025-11-23  
**ëŒ€ìƒ ë…ì**: ê°œë°œíŒ€

---

## ğŸ“‹ ê°œìš”

ë³¸ ë¬¸ì„œëŠ” imagesfactory í”„ë¡œì íŠ¸ì˜ ì‹¤ì œ ê°œë°œ ì§„í–‰ ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.

---

## ğŸš€ ê°œë°œ ì‹œì‘í•˜ê¸°

### ì‚¬ì „ ì¤€ë¹„

1. **í•„ìˆ˜ ì†Œí”„íŠ¸ì›¨ì–´ ì„¤ì¹˜**
   ```bash
   # Node.js 20 LTS
   nvm install 20
   nvm use 20
   
   # pnpm
   npm install -g pnpm
   
   # Firebase CLI
   npm install -g firebase-tools
   ```

2. **Firebase í”„ë¡œì íŠ¸ ì„¤ì •**
   - Firebase Consoleì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±
   - `docs/04_Firebase_ì„¤ì •_ê°€ì´ë“œ.md` ì°¸ê³ 

3. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**
   - `.env.example` íŒŒì¼ ë³µì‚¬í•˜ì—¬ `.env.local` ìƒì„±
   - í•„ìš”í•œ API í‚¤ ì…ë ¥

---

## ğŸ“… ê°œë°œ ë‹¨ê³„ë³„ ê°€ì´ë“œ

## Phase 1: í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì • (1ì¼)

### 1.1 Next.js í”„ë¡œì íŠ¸ ìƒì„±

```bash
cd /Users/songminju/imagesfactory
npx create-next-app@latest . --typescript --tailwind --app --src-dir
```

ì„ íƒ ì‚¬í•­:
- TypeScript: Yes
- ESLint: Yes
- Tailwind CSS: Yes
- src/ directory: Yes
- App Router: Yes
- Import alias (@/*): Yes

### 1.2 í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
# Firebase
pnpm add firebase firebase-admin

# UI ë¼ì´ë¸ŒëŸ¬ë¦¬
pnpm add @radix-ui/react-dialog @radix-ui/react-dropdown-menu @radix-ui/react-label @radix-ui/react-slot
pnpm add class-variance-authority clsx tailwind-merge
pnpm add lucide-react

# í¼ & ê²€ì¦
pnpm add react-hook-form zod @hookform/resolvers

# ìƒíƒœ ê´€ë¦¬
pnpm add zustand
pnpm add @tanstack/react-query

# ìœ í‹¸ë¦¬í‹°
pnpm add axios date-fns

# ì´ë¯¸ì§€ ì²˜ë¦¬
pnpm add sharp

# ê°œë°œ ë„êµ¬
pnpm add -D @types/node @types/react @types/react-dom
pnpm add -D eslint-config-prettier prettier
```

### 1.3 shadcn/ui ì´ˆê¸°í™”

```bash
npx shadcn-ui@latest init
```

ì„¤ì •:
- Style: Default
- Base color: Slate
- CSS variables: Yes

í•„ìš”í•œ ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜:
```bash
npx shadcn-ui@latest add button
npx shadcn-ui@latest add input
npx shadcn-ui@latest add label
npx shadcn-ui@latest add card
npx shadcn-ui@latest add dialog
npx shadcn-ui@latest add dropdown-menu
npx shadcn-ui@latest add toast
npx shadcn-ui@latest add progress
npx shadcn-ui@latest add tabs
npx shadcn-ui@latest add avatar
npx shadcn-ui@latest add badge
npx shadcn-ui@latest add separator
```

### 1.4 Firebase ì´ˆê¸°í™”

```bash
firebase init
```

ì„ íƒ:
- Firestore
- Functions
- Storage
- Emulators

### 1.5 í”„ë¡œì íŠ¸ êµ¬ì¡° ìƒì„±

```bash
mkdir -p src/components/{ui,auth,generation,layout,shared}
mkdir -p src/lib
mkdir -p src/services
mkdir -p src/hooks
mkdir -p src/types
mkdir -p src/store
mkdir -p functions/src
```

### 1.6 Git ì»¤ë°‹

```bash
git add .
git commit -m "chore: í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì • ì™„ë£Œ"
```

---

## Phase 2: Firebase ì—°ë™ (1ì¼)

### 2.1 Firebase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

#### src/lib/firebase.ts

```typescript
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, connectAuthEmulator } from 'firebase/auth';
import { getFirestore, connectFirestoreEmulator } from 'firebase/firestore';
import { getStorage, connectStorageEmulator } from 'firebase/storage';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

// Firebase ì•± ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€)
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];

// ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
export const auth = getAuth(app);
export const db = getFirestore(app);
export const storage = getStorage(app);

// ì—ë®¬ë ˆì´í„° ì—°ê²° (ë¡œì»¬ ê°œë°œ)
if (process.env.NEXT_PUBLIC_USE_FIREBASE_EMULATOR === 'true') {
  connectAuthEmulator(auth, 'http://localhost:9099');
  connectFirestoreEmulator(db, 'localhost', 8080);
  connectStorageEmulator(storage, 'localhost', 9199);
}

export default app;
```

#### src/lib/firebase-admin.ts

```typescript
import * as admin from 'firebase-admin';

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert({
      projectId: process.env.FIREBASE_ADMIN_PROJECT_ID,
      clientEmail: process.env.FIREBASE_ADMIN_CLIENT_EMAIL,
      privateKey: process.env.FIREBASE_ADMIN_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  });
}

export const adminDb = admin.firestore();
export const adminAuth = admin.auth();
export const adminStorage = admin.storage();
export const fieldValue = admin.firestore.FieldValue;

export default admin;
```

### 2.2 íƒ€ì… ì •ì˜

#### src/types/user.types.ts

```typescript
import { Timestamp } from 'firebase/firestore';

export interface User {
  uid: string;
  email: string;
  displayName: string;
  photoURL?: string;
  provider: 'password' | 'google';
  points: number;
  emailVerified: boolean;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

#### src/types/generation.types.ts

```typescript
import { Timestamp } from 'firebase/firestore';

export type GenerationStatus = 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled';

export interface ImageGeneration {
  id: string;
  userId: string;
  prompt: string;
  promptKo?: string;
  promptTranslated: string;
  imageCount: number;
  style: string;
  aspectRatio: string;
  status: GenerationStatus;
  progress: number;
  pointsUsed: number;
  completedAt?: Timestamp;
  failedReason?: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

export interface GeneratedImage {
  id: string;
  imageUrl: string;
  thumbnailUrl: string;
  order: number;
  width: number;
  height: number;
  fileSize: number;
  createdAt: Timestamp;
}
```

### 2.3 Firestore í—¬í¼ í•¨ìˆ˜

#### src/lib/firestore.ts

```typescript
import { 
  collection, 
  doc, 
  getDoc, 
  getDocs, 
  setDoc, 
  updateDoc, 
  deleteDoc,
  query,
  where,
  orderBy,
  limit,
  Timestamp,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from './firebase';

// ì»¬ë ‰ì…˜ ì°¸ì¡°
export const collections = {
  users: () => collection(db, 'users'),
  imageGenerations: () => collection(db, 'imageGenerations'),
  pointTransactions: () => collection(db, 'pointTransactions'),
  payments: () => collection(db, 'payments'),
};

// ì‚¬ìš©ì ì¡°íšŒ
export const getUser = async (uid: string) => {
  const userDoc = await getDoc(doc(collections.users(), uid));
  return userDoc.exists() ? userDoc.data() : null;
};

// ì‚¬ìš©ì ìƒì„±
export const createUser = async (uid: string, data: any) => {
  await setDoc(doc(collections.users(), uid), {
    ...data,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
  });
};

// ì‚¬ìš©ì ì—…ë°ì´íŠ¸
export const updateUser = async (uid: string, data: any) => {
  await updateDoc(doc(collections.users(), uid), {
    ...data,
    updatedAt: serverTimestamp(),
  });
};
```

### 2.4 Git ì»¤ë°‹

```bash
git add .
git commit -m "feat: Firebase í´ë¼ì´ì–¸íŠ¸ ë° í—¬í¼ í•¨ìˆ˜ ì¶”ê°€"
```

---

## Phase 3: ì¸ì¦ ì‹œìŠ¤í…œ (2-3ì¼)

### 3.1 ì¸ì¦ ì„œë¹„ìŠ¤

#### src/services/auth.service.ts

```typescript
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
  signOut as firebaseSignOut,
  sendEmailVerification,
  sendPasswordResetEmail,
  User as FirebaseUser,
} from 'firebase/auth';
import { auth } from '@/lib/firebase';
import { createUser, getUser } from '@/lib/firestore';

// ì´ë©”ì¼ íšŒì›ê°€ì…
export const signUp = async (email: string, password: string, displayName: string) => {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
    await createUser(user.uid, {
      uid: user.uid,
      email: user.email,
      displayName,
      provider: 'password',
      points: 1000, // ê°€ì… ë³´ë„ˆìŠ¤
      emailVerified: false,
    });
    
    // ì´ë©”ì¼ ì¸ì¦ ë°œì†¡
    await sendEmailVerification(user);
    
    return { success: true, user };
  } catch (error: any) {
    throw new Error(getAuthErrorMessage(error.code));
  }
};

// ì´ë©”ì¼ ë¡œê·¸ì¸
export const signIn = async (email: string, password: string) => {
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    return { success: true, user: userCredential.user };
  } catch (error: any) {
    throw new Error(getAuthErrorMessage(error.code));
  }
};

// êµ¬ê¸€ ë¡œê·¸ì¸
export const signInWithGoogle = async () => {
  try {
    const provider = new GoogleAuthProvider();
    const userCredential = await signInWithPopup(auth, provider);
    const user = userCredential.user;
    
    // ì‹ ê·œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
    const existingUser = await getUser(user.uid);
    
    if (!existingUser) {
      // ì‹ ê·œ ì‚¬ìš©ì ìƒì„±
      await createUser(user.uid, {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL,
        provider: 'google',
        points: 1000, // ê°€ì… ë³´ë„ˆìŠ¤
        emailVerified: true,
      });
    }
    
    return { success: true, user };
  } catch (error: any) {
    throw new Error(getAuthErrorMessage(error.code));
  }
};

// ë¡œê·¸ì•„ì›ƒ
export const signOut = async () => {
  await firebaseSignOut(auth);
};

// ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
export const resetPassword = async (email: string) => {
  await sendPasswordResetEmail(auth, email);
};

// ì—ëŸ¬ ë©”ì‹œì§€ ë³€í™˜
function getAuthErrorMessage(code: string): string {
  const messages: Record<string, string> = {
    'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
    'auth/invalid-email': 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.',
    'auth/operation-not-allowed': 'ì´ ì‘ì—…ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (ìµœì†Œ 6ì)',
    'auth/user-disabled': 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.',
    'auth/user-not-found': 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.',
    'auth/wrong-password': 'ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.',
    'auth/too-many-requests': 'ë„ˆë¬´ ë§ì€ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
    'auth/network-request-failed': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    'auth/popup-closed-by-user': 'íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.',
  };
  
  return messages[code] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
}
```

### 3.2 ì¸ì¦ Context & Hook

#### src/hooks/useAuth.ts

```typescript
import { useState, useEffect } from 'react';
import { onAuthStateChanged, User as FirebaseUser } from 'firebase/auth';
import { auth } from '@/lib/firebase';
import { getUser } from '@/lib/firestore';
import { User } from '@/types/user.types';

export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [firebaseUser, setFirebaseUser] = useState<FirebaseUser | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
      setFirebaseUser(firebaseUser);
      
      if (firebaseUser) {
        // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userData = await getUser(firebaseUser.uid);
        setUser(userData as User);
      } else {
        setUser(null);
      }
      
      setLoading(false);
    });
    
    return unsubscribe;
  }, []);
  
  return { user, firebaseUser, loading };
};
```

### 3.3 ë¡œê·¸ì¸ í˜ì´ì§€

#### src/app/(auth)/login/page.tsx

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { signIn, signInWithGoogle } from '@/services/auth.service';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from '@/components/ui/use-toast';

const loginSchema = z.object({
  email: z.string().email('ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'),
  password: z.string().min(6, 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'),
});

type LoginForm = z.infer<typeof loginSchema>;

export default function LoginPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  
  const { register, handleSubmit, formState: { errors } } = useForm<LoginForm>({
    resolver: zodResolver(loginSchema),
  });
  
  const onSubmit = async (data: LoginForm) => {
    try {
      setLoading(true);
      await signIn(data.email, data.password);
      toast({ title: 'ë¡œê·¸ì¸ ì„±ê³µ!' });
      router.push('/dashboard');
    } catch (error: any) {
      toast({
        title: 'ë¡œê·¸ì¸ ì‹¤íŒ¨',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };
  
  const handleGoogleSignIn = async () => {
    try {
      setLoading(true);
      await signInWithGoogle();
      toast({ title: 'ë¡œê·¸ì¸ ì„±ê³µ!' });
      router.push('/dashboard');
    } catch (error: any) {
      toast({
        title: 'ë¡œê·¸ì¸ ì‹¤íŒ¨',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>ë¡œê·¸ì¸</CardTitle>
          <CardDescription>imagesfactoryì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
            <div>
              <Label htmlFor="email">ì´ë©”ì¼</Label>
              <Input
                id="email"
                type="email"
                placeholder="your@email.com"
                {...register('email')}
              />
              {errors.email && (
                <p className="mt-1 text-sm text-red-600">{errors.email.message}</p>
              )}
            </div>
            
            <div>
              <Label htmlFor="password">ë¹„ë°€ë²ˆí˜¸</Label>
              <Input
                id="password"
                type="password"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                {...register('password')}
              />
              {errors.password && (
                <p className="mt-1 text-sm text-red-600">{errors.password.message}</p>
              )}
            </div>
            
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
            </Button>
          </form>
          
          <div className="relative my-4">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-white px-2 text-gray-500">ë˜ëŠ”</span>
            </div>
          </div>
          
          <Button
            type="button"
            variant="outline"
            className="w-full"
            onClick={handleGoogleSignIn}
            disabled={loading}
          >
            <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
              {/* Google ì•„ì´ì½˜ SVG */}
            </svg>
            Googleë¡œ ë¡œê·¸ì¸
          </Button>
        </CardContent>
        <CardFooter className="flex flex-col space-y-2">
          <Link href="/reset-password" className="text-sm text-blue-600 hover:underline">
            ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?
          </Link>
          <p className="text-sm text-gray-600">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?{' '}
            <Link href="/signup" className="text-blue-600 hover:underline">
              íšŒì›ê°€ì…
            </Link>
          </p>
        </CardFooter>
      </Card>
    </div>
  );
}
```

### 3.4 Git ì»¤ë°‹

```bash
git add .
git commit -m "feat: ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ (ì´ë©”ì¼, êµ¬ê¸€ ë¡œê·¸ì¸)"
```

---

## Phase 4: ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥ (3-4ì¼)

### 4.1 AI ì„œë¹„ìŠ¤

#### src/services/ai.service.ts

```typescript
import axios from 'axios';

interface GenerateImageOptions {
  prompt: string;
  style: string;
  aspectRatio: string;
}

// DALL-E 3ë¡œ ì´ë¯¸ì§€ ìƒì„±
export const generateImageWithDALLE = async (options: GenerateImageOptions): Promise<string> => {
  const { prompt, aspectRatio } = options;
  
  // í•´ìƒë„ ë§¤í•‘
  const sizeMap: Record<string, string> = {
    '1:1': '1024x1024',
    '16:9': '1792x1024',
    '9:16': '1024x1792',
  };
  
  const response = await axios.post(
    'https://api.openai.com/v1/images/generations',
    {
      model: 'dall-e-3',
      prompt,
      n: 1,
      size: sizeMap[aspectRatio] || '1024x1024',
      quality: 'standard',
    },
    {
      headers: {
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
    }
  );
  
  return response.data.data[0].url;
};

// í”„ë¡¬í”„íŠ¸ ë²ˆì—­ (í•œê¸€ â†’ ì˜ë¬¸)
export const translatePrompt = async (text: string): Promise<string> => {
  // Google Translate API ì‚¬ìš©
  const response = await axios.post(
    `https://translation.googleapis.com/language/translate/v2?key=${process.env.GOOGLE_TRANSLATE_API_KEY}`,
    {
      q: text,
      source: 'ko',
      target: 'en',
    }
  );
  
  return response.data.data.translations[0].translatedText;
};
```

### 4.2 ìƒì„± ì„œë¹„ìŠ¤

#### src/services/generation.service.ts

```typescript
import { addDoc, serverTimestamp } from 'firebase/firestore';
import { collections } from '@/lib/firestore';
import { translatePrompt } from './ai.service';
import { deductPoints } from './point.service';

interface CreateGenerationParams {
  userId: string;
  prompt: string;
  imageCount: number;
  style: string;
  aspectRatio: string;
}

export const createGeneration = async (params: CreateGenerationParams) => {
  const { userId, prompt, imageCount, style, aspectRatio } = params;
  
  // í¬ì¸íŠ¸ ê³„ì‚°
  const pointsNeeded = imageCount * 100;
  
  // í¬ì¸íŠ¸ ì°¨ê°
  await deductPoints(userId, pointsNeeded, `ì´ë¯¸ì§€ ${imageCount}ì¥ ìƒì„±`);
  
  // í”„ë¡¬í”„íŠ¸ ë²ˆì—­ (í•œê¸€ì¸ ê²½ìš°)
  const isKorean = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/.test(prompt);
  const promptTranslated = isKorean ? await translatePrompt(prompt) : prompt;
  
  // ìƒì„± ì‘ì—… ìƒì„±
  const generationRef = await addDoc(collections.imageGenerations(), {
    userId,
    prompt,
    promptKo: isKorean ? prompt : undefined,
    promptTranslated,
    imageCount,
    style,
    aspectRatio,
    status: 'pending',
    progress: 0,
    pointsUsed: pointsNeeded,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
  });
  
  return generationRef.id;
};
```

### 4.3 í¬ì¸íŠ¸ ì„œë¹„ìŠ¤

#### src/services/point.service.ts

```typescript
import { runTransaction, doc, serverTimestamp } from 'firebase/firestore';
import { db, collections } from '@/lib/firestore';

export const deductPoints = async (userId: string, amount: number, description: string) => {
  await runTransaction(db, async (transaction) => {
    const userRef = doc(collections.users(), userId);
    const userDoc = await transaction.get(userRef);
    
    if (!userDoc.exists()) {
      throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    const currentPoints = userDoc.data().points || 0;
    
    if (currentPoints < amount) {
      throw new Error(`í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${amount}, í˜„ì¬: ${currentPoints})`);
    }
    
    const newPoints = currentPoints - amount;
    
    // í¬ì¸íŠ¸ ì°¨ê°
    transaction.update(userRef, {
      points: newPoints,
      updatedAt: serverTimestamp(),
    });
    
    // ê±°ë˜ ë‚´ì—­ ìƒì„±
    transaction.set(doc(collections.pointTransactions()), {
      userId,
      amount: -amount,
      type: 'usage',
      description,
      balanceBefore: currentPoints,
      balanceAfter: newPoints,
      createdAt: serverTimestamp(),
    });
  });
};
```

### 4.4 ìƒì„± í˜ì´ì§€

#### src/app/(dashboard)/create/page.tsx

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useAuth } from '@/hooks/useAuth';
import { createGeneration } from '@/services/generation.service';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from '@/components/ui/use-toast';

const createSchema = z.object({
  prompt: z.string()
    .min(10, 'í”„ë¡¬í”„íŠ¸ëŠ” ìµœì†Œ 10ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤')
    .max(1000, 'í”„ë¡¬í”„íŠ¸ëŠ” ìµœëŒ€ 1000ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤'),
  imageCount: z.number().min(1).max(50),
  style: z.enum(['realistic', 'artistic', 'anime', '3d']),
  aspectRatio: z.enum(['1:1', '16:9', '9:16', '4:3']),
});

type CreateForm = z.infer<typeof createSchema>;

export default function CreatePage() {
  const router = useRouter();
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  
  const { register, handleSubmit, watch, formState: { errors } } = useForm<CreateForm>({
    resolver: zodResolver(createSchema),
    defaultValues: {
      imageCount: 10,
      style: 'realistic',
      aspectRatio: '1:1',
    },
  });
  
  const imageCount = watch('imageCount');
  const pointsNeeded = imageCount * 100;
  
  const onSubmit = async (data: CreateForm) => {
    if (!user) return;
    
    if (user.points < pointsNeeded) {
      toast({
        title: 'í¬ì¸íŠ¸ ë¶€ì¡±',
        description: 'í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•´ì£¼ì„¸ìš”.',
        variant: 'destructive',
      });
      router.push('/points');
      return;
    }
    
    try {
      setLoading(true);
      const generationId = await createGeneration({
        userId: user.uid,
        ...data,
      });
      
      toast({ title: 'ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ ì™„ë£Œ!' });
      router.push(`/history/${generationId}`);
    } catch (error: any) {
      toast({
        title: 'ìƒì„± ì‹¤íŒ¨',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="container max-w-4xl py-8">
      <Card>
        <CardHeader>
          <CardTitle>ì´ë¯¸ì§€ ìƒì„±</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
            {/* í”„ë¡¬í”„íŠ¸ ì…ë ¥ */}
            <div>
              <Label htmlFor="prompt">í”„ë¡¬í”„íŠ¸</Label>
              <Textarea
                id="prompt"
                placeholder="ìƒì„±í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”..."
                rows={5}
                {...register('prompt')}
              />
              {errors.prompt && (
                <p className="mt-1 text-sm text-red-600">{errors.prompt.message}</p>
              )}
            </div>
            
            {/* ì´ë¯¸ì§€ ìˆ˜ëŸ‰ */}
            <div>
              <Label htmlFor="imageCount">ì´ë¯¸ì§€ ìˆ˜ëŸ‰: {imageCount}ì¥</Label>
              <Input
                id="imageCount"
                type="range"
                min="1"
                max="50"
                {...register('imageCount', { valueAsNumber: true })}
              />
            </div>
            
            {/* ìŠ¤íƒ€ì¼ ì„ íƒ */}
            <div>
              <Label>ìŠ¤íƒ€ì¼</Label>
              <RadioGroup defaultValue="realistic">
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="realistic" id="realistic" {...register('style')} />
                  <Label htmlFor="realistic">ì‚¬ì‹¤ì </Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="artistic" id="artistic" {...register('style')} />
                  <Label htmlFor="artistic">ì˜ˆìˆ ì </Label>
                </div>
                {/* ... ê¸°íƒ€ ìŠ¤íƒ€ì¼ */}
              </RadioGroup>
            </div>
            
            {/* ì˜ˆìƒ ë¹„ìš© */}
            <div className="rounded-lg border p-4">
              <div className="flex justify-between">
                <span>ì˜ˆìƒ í¬ì¸íŠ¸:</span>
                <span className="font-bold">{pointsNeeded.toLocaleString()} í¬ì¸íŠ¸</span>
              </div>
              <div className="flex justify-between text-sm text-gray-600">
                <span>í˜„ì¬ í¬ì¸íŠ¸:</span>
                <span>{user?.points.toLocaleString()} í¬ì¸íŠ¸</span>
              </div>
            </div>
            
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'ìƒì„± ì¤‘...' : 'ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

### 4.5 Git ì»¤ë°‹

```bash
git add .
git commit -m "feat: ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥ êµ¬í˜„"
```

---

## âš ï¸ ì¤‘ìš” ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì½”ë“œ ì‘ì„± ì „
- [ ] .cursorrules íŒŒì¼ í™•ì¸
- [ ] ê´€ë ¨ ê¸°íš ë¬¸ì„œ ì½ê¸°
- [ ] íƒ€ì… ì •ì˜ í™•ì¸

### ì½”ë“œ ì‘ì„± ì¤‘
- [ ] TypeScript íƒ€ì… ì•ˆì „ì„±
- [ ] ì—ëŸ¬ ì²˜ë¦¬ (try-catch)
- [ ] Firebase ë³´ì•ˆ ê·œì¹™ ê³ ë ¤
- [ ] í•œêµ­ì–´ ì£¼ì„ ë° ë©”ì‹œì§€

### ì½”ë“œ ì‘ì„± í›„
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸
- [ ] ESLint í†µê³¼
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] Git ì»¤ë°‹

---

**ë‹¤ìŒ ë‹¨ê³„**: Phase 5ë¶€í„°ëŠ” ê²°ì œ ì‹œìŠ¤í…œ, ì´ë©”ì¼ ì „ì†¡, ê´€ë¦¬ì í˜ì´ì§€ ë“±ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

**ë¬¸ì„œ íˆìŠ¤í† ë¦¬**
- v1.0 (2025-11-23): ì´ˆì•ˆ ì‘ì„±

